{{!-- Copyright 2021, Yahoo Holdings Inc. Licensed under the terms of the MIT license. See accompanying LICENSE.md file for terms. --}}
<div class="navi-report">

  <div class="container-full m-b-4">
    <div class="row m-t-10">
      <div class="xs-col-1-1 sm-col-1-2 col-1-5 p-x-0">
        {{#if (feature-flag "enableDirectory")}}
          <LinkTo @route="directory.my-data" class="navi-report__breadcrumb-link">Directory</LinkTo>
        {{else}}
          <LinkTo @route="reports" class="navi-report__breadcrumb-link">Reports</LinkTo>
        {{/if}}
        <NaviIcon @icon="angle-right" />
      </div>
    </div>
    <div class="row">
      <div class="xs-col-10-10 sm-col-10-10 col-3-10 p-x-0">
        <div class="row">
          <span class="navi-report__title">
          {{#if this.model.isOwner}}
            <EditableLabel
              class="navi-report__edit-title"
              @value={{this.model.title}}
              @onChange={{route-action "updateTitle"}}
            />
          {{else}}
            <span>{{this.model.title}}</span>
          {{/if}}

          {{!-- Favorite icon is visible if a report has been saved --}}
          {{#unless this.model.isNew}}
            {{#let (get-user) as |user|}}
              <FavoriteItem
                class="navi-report__fav-icon"
                @user={{user}}
                @item={{this.model}}
                @click={{route-action "toggleFavorite" this.model}}
              />
            {{/let}}
          {{/unless}}
          </span>
        </div>
      </div>
      <div class="xs-col-10-10 sm-col-10-10 col-7-10 m-t-10 p-x-0">
        <div class="row navi-report__header">
            {{#if (feature-flag "dashboards")}}
              {{!-- Disabling to allow calling report-to-widget mixin actions --}}
              {{!-- template-lint-disable no-action --}}
              <ReportActions @model={{this.model}} @addToDashboard={{action "addToDashboard"}} @addToNewDashboard={{action "addToNewDashboard"}} />
            {{else}}
              <ReportActions @model={{this.model}} />
            {{/if}}
        </div>
      </div>
    </div>
  </div>

  <div class="navi-report__body">
    <ReportBuilder
      @report={{this.model}}
      @disabled={{this.isRunningReport}}
      @isFiltersCollapsed={{this.isFiltersCollapsed}}
      @onUpdateFiltersCollapsed={{fn (mut this.isFiltersCollapsed)}}
      @onBeforeAddItem={{this.onBeforeAddItem}}
      as |builder|
    >
      <NaviColumnConfig
        class="{{if this.isRunningReport "navi-column-config--disabled"}}"
        @isOpen={{this.isColumnDrawerOpen}}
        @lastAddedColumn={{this.lastAddedColumn}}
        @report={{this.model}}
        @openFilters={{route-action "openFilters"}}
        @onAddColumn={{update-report-action "ADD_COLUMN_WITH_PARAMS"}}
        @onRemoveColumn={{update-report-action "REMOVE_COLUMN_FRAGMENT"}}
        @onToggleFilter={{update-report-action "TOGGLE_FILTER"}}
        @onRenameColumn={{update-report-action "RENAME_COLUMN_FRAGMENT"}}
        @onReorderColumn={{update-report-action "REORDER_COLUMN_FRAGMENT"}}
        @onUpdateColumnParam={{update-report-action "UPDATE_COLUMN_FRAGMENT_WITH_PARAMS"}}
      />

      <div class="report-view__columns-toggle">
        <button class="report-view__columns-button" type="button" aria-label="Toggle column drawer" {{on "click" (fn this.updateColumnDrawerOpen (not this.isColumnDrawerOpen) builder)}}>
          {{#animated-if this.isColumnDrawerOpen use=this.fadeTransition}}
            <NaviIcon @icon="chevron-left" class="report-view__columns-icon" />
          {{else}}
            <NaviIcon @icon="columns" class="report-view__columns-icon" />
          {{/animated-if}}
        </button>
      </div>
      {{outlet}}
    </ReportBuilder>
  </div>

  <footer class="navi-report__footer row xs-space-between">
    {{#unless this.isRunningReport}}

      <DenaliButton
        class="navi-report__run-btn xs-col-1-1"
        {{on "click" (pipe (route-action "validate" this.model) (route-action "forceRun" this.model))}}
      >
        Run
      </DenaliButton>

      {{#if (and this.model.isOwner this.model.hasDirtyAttributes)}}
        <DenaliButton
          class="navi-report__save-btn xs-col-1-3"
          @style="ghost"
          {{on "click" (pipe (route-action "validate" this.model) (route-action "runReport" this.model) (route-action "saveReport" this.model))}}
        >
          {{#if this.model.isNew}}
            Save Report
          {{else}}
            Save
          {{/if}}
        </DenaliButton>

        {{#unless this.model.isNew}}
          <ReportActions::SaveAs
            @model={{this.model}}
            as |toggleModal|
          >
            <DenaliButton
              class="navi-report__save-as-btn hide-mobile"
              @style="text"
              {{on "click" (pipe (route-action "validate" this.model) toggleModal)}}
            >
              Duplicate
            </DenaliButton>
          </ReportActions::SaveAs>
        {{/unless}}
      {{/if}}

      {{#if (and this.model.hasDirtyAttributes (not this.model.isNew))}}
        <DenaliButton
          class="navi-report__revert-btn xs-col-1-3"
          @style="text"
          {{on "click" (route-action "revertChanges" this.model)}}
        >
          Revert
        </DenaliButton>
      {{/if}}

    {{else}}
      <DenaliButton class="navi-report__cancel-btn xs-col-1-1" {{on "click" (route-action "cancelReport" this.model)}}>
        Cancel
      </DenaliButton>
    {{/unless}}
  </footer>
</div>
